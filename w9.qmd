---
title: "R Coding Workshop: 7th Meeting"
subtitle: "GIS & Geospatial Data Analysis (Fall 2025)"
execute:
  echo: true
format:
  html:
    output-file: "w9-idx.html"
    css: styles.css
    toc: true
    df-print: kable
  revealjs:
    output-file: "w9-slides.html"
    css: styles.css
    df-print: kable
    slide-number: true
    scrollable: true
    code:
      echo: true
      eval: true
bibliography: r4spatial-workshop.bib
---

## R Coding Workshop for GIS: 7th Meeting

## Goals for Today

- Review R fundamentals
- Walk through the R workflow for (geospatial) data analysis
- Make sense of objects and functions in R
- Move back and forth with `df`, `sf`, `ppp`
- Intro to control flow (`if` and `case_when`)

## Review

> 1. Everything that exists in R is an **object**.(@chambersExtending2016)^[p. 4]
> 2. R uses **functions** to perform operations.(@jamesIntroductionStatisticalLearning2021a)^[@jamesIntroductionStatisticalLearning2021a, p. 43]

## The Workflow 1: Setting up the Environment

- select a working environment and explore their features(Positron, Jupyterhub)
- Open your .qmd file or create one

### R Session

- Use `getwd()` and `setwd()` to get information about **working directory** the or set them manually to tell R where to look for files during this session

```{.r}
getwd()
setwd('~/myfolder')
```

- Use the `library()` function to load the **packages** for our R session.
```{r}
#| output: false
library(tidyverse)
library(sf)
library(mapview)
library(rnaturalearth)
library(viridis)
library(spdep)
library(sfdep)
library(spatstat)
library(terra)
library(stars)
```

## The Workflow 2: Preparing Data objects

```{r}
uni_df <- tibble::tribble(
  ~university, ~year, ~current_country, ~lat, ~lon, ~exist_today,
  "Paris", 1150, "France", 48.8566, 2.3522, TRUE,
  "Salerno", 1173,  "Italy", 40.7711, 14.7905, TRUE,
  "Reggio", 1188, "Italy", 44.6450, 10.9277, TRUE,
  "Oxford", 1190, "United Kingdom", 51.7520, -1.2576, TRUE,
  "Bologna", 1200, "Italy", 44.4989, 11.3275, TRUE
)
# uni_df
uni_sf <- uni_df |>
    st_as_sf(
        coords = c('lon','lat'),
        crs = 4326
    )
# uni_sf |> mapview(label = 'university')
uni_sfc <- uni_sf |> pull(geometry)
```

```{r}
book_challenge_df <- read_csv('data/book-challenge11.csv')
```

```{r}
ne_vars <- c("geounit", "pop_est", "pop_rank", "pop_year", "gdp_md", "gdp_year", "economy", "income_grp", "iso_a2", "continent", "region_un", "subregion", "region_wb")
cca_sf <- ne_countries(
    country = c(
        "Kazakhstan", "Kyrgyzstan", "Tajikistan", "Turkmenistan", "Uzbekistan", "Armenia", "Azerbaijan", "Georgia"),
    scale = 50) |> select(any_of(ne_vars))
cca_sfc <- cca_sf |> st_geometry()
```
```{r}
azerbaijan_sf <- cca_sf |> filter(iso_a2 == 'AZ')
azerbaijan_sfc <- azerbaijan_sf |> st_geometry()
```
```{r}
georgia_sf <- cca_sf |> filter(iso_a2 == 'GE')
```
```{r}
cca_nb <- cca_sf |> st_contiguity()
cca_listw <- cca_nb |> st_weights()
```

## 3. Finding Help: read function documentations

Ways to access function documentation:

1. Add a question mark in front of the function name: `?func_name`
```{r}
?mutate
```

```{r}
??"aggregate"
```

2. Use the `help()` function

```{r}
help('mutate')
```
```{r}
help('filter', package = 'dplyr')
```

3. If you are interested in the what are the arguments that the function can take, use `args()` to check

```{r}
moran |> class() |> print()
args(moran)
```

4. Simply, hover over the function name!
```{r}
'Try hover over a function in your code!' |> print()
```

## A closer look at the data structure of an **df** object

- `class()` function tells us that `uni_df` is a "data.frame" object data object with an additional class `"tbl_df"
- `typeof()` call shows the storage mode of `uni_df`, which is **list**

```{r}
uni_df |> class() |> print()
uni_df |> typeof() |> print()
```

- describe and extract attributes of a df object using `dim()` and `colnames()`
```{r}
uni_df |> dim() |> print()
uni_df |> colnames()
```

## Longer and Wider Dataframes

```{r}
book_challenge_df <- read_csv('data/book-challenge11.csv')
book_challenge_df |> dim() |> print()
```

- basic display functions: `head()`, `tail()` and `slice_sample()`

```{r}
book_challenge_df |> tail()
```
```{r}
book_challenge_df |> slice_sample(n = 4)
```

- optimized display to show all columns `glimpse()`

```{r}
book_challenge_df |> glimpse()
```

- `view()` tidyverse `summary()` equivalent
```{r}
book_challenge_df |> view()
```

## The structure and the components of an **sf** object

:::: {.columns}
::: {.column}

- an sf object can simultaneously be of classes "sf", "tbl_df" and "data.frame"
- Using the function `typeof()` or `mode()` we can inspect that `uni_sf` is stored as using a *list*

:::
::: {.column}
```{r}
uni_sf |> class()
```

```{r}
uni_sf |> typeof()
```
:::
::::

### Attributes of an **sf** object

- df attributes
- sf column
  - coordinate reference system: `st_crs()`
  - bounding box: `st_bbox()`
  - geometry type
- attribute-geometry-relationship

:::: {.columns}
::: {.column}
```{r}
uni_sf
```
:::
::: {.column}

```{r}
uni_sf |> str()
```
:::
::::

```{r}
uni_sf |> st_crs()
uni_sf |> st_bbox() |> st_as_sfc() |> st_as_sf() |> mapview()
```


## Geometry column: a closer look

1. Get the name of the geometry column
```{r}
uni_sf |> attr(which = 'sf_column')
```

1. Single out the geometry column

- `pull()` tidyverse equivalent for `$`: input a df, a column name, output a **vector**
```{r}
uni_sf |> pull(geometry) |> class()
uni_sfc <- uni_sf |> pull(geometry)
# uni_sfc <- uni_sf$geometry
```

- or `st_geometry()`
```{r}
uni_sfc <- uni_sf |> st_geometry()
```

```{r}
uni_sfc |> class() |> print()
uni_sfc |> typeof()
```

- access list items

```{r}
uni_sfc[[4]]
```

```{r}
uni_sfc[[4]] |> class()
```

summary

:::: {.columns}
::: {.column width="33%}
(1) `sf`: simple feature collection.

```{r}
uni_sf
```

:::
::: {.column width="33%}

(2) `sfc`: simple feature list-column(@pebesmaSpatialDataScience2023)

```{r}
uni_sfc
```

:::
::: {.column width="33%}

(3) `sfg`: single geometry

```{r}
uni_sfc[[4]]
```

:::
::::

## st_geometry: make use of the list structure

```{r}
azerbaijan_sf <- cca_sf |> filter(iso_a2 == 'AZ')
```

```{r}
azerbaijan_sf |> mapview()
```
```{r}
azerbaijan_sf |> glimpse()
```

:::: {.columns}
::: {.column}

- save the sf geometry column as `azerbaijan_sfc`
```{r}
azerbaijan_sfc <- azerbaijan_sf |> st_geometry()
azerbaijan_sfc |> glimpse()
```

:::
::: {.column}

```{r}
azerbaijan_sfc |> class() |> print()
azerbaijan_sfc |> typeof() |> print()
azerbaijan_sfc[[1]][[3]][[1]] |> class()
azerbaijan_sfc[[1]][[3]][[1]]
```

:::
::::


```{r}
az_poly1 <- azerbaijan_sfc[[1]][[1]] |> st_polygon()
az_poly2 <- azerbaijan_sfc[[1]][[2]] |> st_polygon()
az_poly3 <- azerbaijan_sfc[[1]][[3]] |> st_polygon()

azer_piece_sfc <- list(az_poly1, az_poly2, az_poly3) |>
  st_as_sfc()
```

```{r}
azer_piece_df <- tibble(
    geometry = azer_piece_sfc,
    lab = c('Nagorno-Karabakh', 'Azerbaijan Main', 'Yukhari Askipara')
)
azer_piece_sf <- azer_piece_df |> st_as_sf(crs = 4326)
```
```{r}
azer_piece_sf |> mapview(zcol = 'lab', label = 'lab')
azer_piece_sf
```

## sfg to sfc

##### Inner Ring

:::: {.columns}
::: {.column}

```{r}
azerbaijan_sfc[[1]][[2]][[2]] |> class() |> print()
azerbaijan_sfc[[1]][[2]][[2]]
```

:::
::: {.column}
```{r}
azerbaijan_sfc[[1]][[2]][[2]] |> list() |> st_polygon() |> ggplot() + geom_sf() + theme_bw()
```
:::
::::

#### Outer Ring

:::: {.columns}
::: {.column}
```{r}
azerbaijan_sfc[[1]][[2]][[1]] |> dim() |> print()
azerbaijan_sfc[[1]][[2]][[1]] |> head()
```

:::
::: {.column}
```{r}
azerbaijan_sfc[[1]][[2]][[1]] |> list() |> st_polygon() |> ggplot() + geom_sf() + theme_bw()
```

:::
::::


```{r}
azerbaijan_outer_ring <- azerbaijan_sfc[[1]][[2]][[1]]
azerbaijan_inner_ring <- azerbaijan_sfc[[1]][[2]][[2]]


azerbaijan_polygon <- st_polygon(list(azerbaijan_outer_ring, azerbaijan_inner_ring))

azerbaijan_polygon |>
    ggplot() +
    geom_sf(fill = "lightblue") +
    theme_bw()
```
